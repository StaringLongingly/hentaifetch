#!/bin/sh

tmpfile="$(mktemp)"

echo "$2" | grep -qE '^[0-9]+$' && height="$2" || height="$(($(stty size | awk '{print $1}') - 5))"
[ "$DEBUG" = "true" ] && echo "Using height $height"

if [ "x$1" = "x" ]; then
	id=$(($RANDOM % 350000 + 1))
	echo $id
else
	id=$1
fi


url=$(curl -fsSL "https://nhentai.net/g/$id/" | grep -o "https://t\.nhentai\.net/galleries/[[:digit:]]*/cover\.[[:lower:]]*" | head -1)
echo $url
echo $tmpfile
curl -fsSLo "$tmpfile" "$url"


if [ "$TERM" = "xterm-kitty" ]; then
   command -v convert > /dev/null 2>&1 && neofetch --kitty "$tmpfile" || kitty_imagemagick_warn=true
    if [ "$kitty_imagemagick_warn" = "true" ]; then
        jp2a --height="$height" "$tmpfile" > "$tmpfile"
        neofetch --source "$tmpfile"
    fi
else
    jp2a --height="$height" "$tmpfile" > "$tmpfile"
    neofetch --source "$tmpfile"
fi

rm "$tmpfile"

[ "$kitty_imagemagick_warn" = "true" ] && echo "WARN: imagemagick is required for kitty image backend"
